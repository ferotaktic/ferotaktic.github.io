<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Tanrƒ±nƒ±n Eli ‚Ä¢ Fero ‚Äî Sic Bo (Small/Big) ‚Ä¢ Seri-Kilit (Histerezis) + Z-Skor + Bandit ‚Ä¢ Kelly-Lite ‚Ä¢ Dinamik Geri Kazanƒ±m</title>
<style>
:root{
  --bg:#071022; --card:#0c1830; --muted:#9fb0d9; --text:#e6f0ff;
  --accent:#7c5cff; --accent2:#22e3a2; --danger:#ff6b6b; --btn:linear-gradient(90deg,var(--accent),var(--accent2));
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;background:var(--bg);color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,Arial;line-height:1.35;overflow-x:hidden}
.header{padding:16px;text-align:center;background:linear-gradient(180deg,#081329,#06101f);font-weight:800;color:#22e3a2}
.container{max-width:980px;margin:16px auto;padding:12px}

/* Kart */
.card{background:linear-gradient(180deg,rgba(12,24,48,.95),rgba(8,14,30,.95));
  border:1px solid rgba(124,92,255,.14);border-radius:12px;padding:16px;margin-bottom:16px;
  box-shadow:0 12px 40px rgba(2,6,23,.45)}
.h4{margin:0 0 12px;color:var(--muted);font-size:13px;font-weight:800;text-transform:uppercase;letter-spacing:.5px}
.sub{color:var(--muted);font-size:12px}

/* √ñneri ba≈ülƒ±ƒüƒ± + anlƒ±k stake */
.reco{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.reco-badge{padding:6px 10px;border-radius:999px;font-weight:900}
.reco-wait{background:#334155;color:#cbd5e1}
.reco-small{background:#0b7a5e;color:#a7f3d0}
.reco-big{background:#5c1c1c;color:#fecaca}
.reco-pill{
  display:inline-flex;align-items:center;gap:6px;
  padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);color:#e6f0ff;font-weight:900
}

/* Kayƒ±t butonlarƒ± */
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
@media(max-width:640px){ .grid3{grid-template-columns:1fr} }
.btn{cursor:pointer;border:none;border-radius:10px;padding:12px 14px;font-weight:800;background:var(--btn);
  color:#051025;transition:transform .14s,opacity .14s;min-height:44px;font-size:15px}
.btn:active{transform:scale(.99)}
.btn:hover{transform:translateY(-1px);opacity:.96}
.btn[disabled]{opacity:.55;cursor:not-allowed}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.15);color:var(--text)}
.btn-win{background:#0b7a5e}
.btn-loss{background:#7f1d1d}
.btn-tie{background:#3b2d06}
.row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

/* Tƒ±k hissi ‚Äì g√∂rsel pulse */
@keyframes tapWin{0%{box-shadow:0 0 0 0 rgba(34,227,162,.65);transform:scale(.98)}
  70%{box-shadow:0 0 0 16px rgba(34,227,162,0);transform:scale(1.01)}
  100%{box-shadow:0 0 0 0 rgba(34,227,162,0);transform:scale(1)}}
@keyframes tapLoss{0%{box-shadow:0 0 0 0 rgba(255,107,107,.65);transform:scale(.98)}
  70%{box-shadow:0 0 0 16px rgba(255,107,107,0);transform:scale(1.01)}
  100%{box-shadow:0 0 0 0 rgba(255,107,107,0);transform:scale(1)}}
@keyframes tapTie{0%{box-shadow:0 0 0 0 rgba(234,179,8,.65);transform:scale(.98)}
  70%{box-shadow:0 0 0 16px rgba(234,179,8,0);transform:scale(1.01)}
  100%{box-shadow:0 0 0 0 rgba(234,179,8,0);transform:scale(1)}}
.pulse-win{animation:tapWin .42s ease-out}
.pulse-loss{animation:tapLoss .42s ease-out}
.pulse-tie{animation:tapTie .42s ease-out}
.kbd{background:#0a1327;border:1px solid rgba(255,255,255,.12);padding:6px 8px;border-radius:8px;color:#9fb0d9;font-size:12px}

/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-top:12px}
.kpi{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);padding:12px;border-radius:10px}
.kpi .t{font-size:12px;color:var(--muted)}
.kpi .v{margin-top:6px;font-weight:900}

/* Tablo */
.table-wrap{overflow:auto;max-height:60vh;margin-top:12px;border-radius:10px}
table{width:100%;border-collapse:collapse;font-size:13px;table-layout:fixed}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
th{position:sticky;top:0;background:rgba(7,16,34,.96);color:var(--muted)}

/* Ayarlar ‚Äì en altta, kompakt */
.settings.card{padding:12px}
.form{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px}
.group{display:flex;flex-direction:column;gap:6px}
.label{color:var(--muted);font-size:11px}
.input{
  width:100%;background:transparent;border:1px solid rgba(255,255,255,.12);
  color:#fff;padding:8px 10px;border-radius:10px;min-height:36px;font-size:13px
}
.small-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.note{font-size:12px;color:var(--muted);margin-top:6px}

/* Warm-up panel */
.warm{margin-top:10px;padding:10px;border:1px dashed rgba(255,255,255,.18);border-radius:10px;background:rgba(255,255,255,.03)}
.warm .title{font-weight:900;color:#a7b8e8;margin-bottom:6px}
.warm .p{font-size:12px;color:#9fb0d9}

/* Eri≈üilebilir canlƒ± metin (gizli) */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
<div class="header">üé≤ Tanrƒ±nƒ±n Eli ‚Ä¢ <b>Fero</b> ‚Äî Sic Bo (Small/Big) ‚Ä¢ Seri-Kilit (Histerezis) ‚Ä¢ Z-Skor ‚Ä¢ Bandit ‚Ä¢ Kelly-Lite ‚Ä¢ Dinamik Geri Kazanƒ±m</div>

<div class="container">

  <!-- √ñneri + Eylem -->
  <div class="card">
    <div class="h4">√ñneri</div>
    <div class="reco">
      <div id="recoBadge" class="reco-badge reco-wait">Dur</div>
      <div class="reco-pill">Sƒ±radaki Bahis: <span id="recoStake">30</span> TL</div>
      <div class="sub">Her el <b>Small</b>, <b>Big</b> ya da <b>Tie</b> tu≈üla. Sistem ‚ÄúDur / K√º√ß√ºƒüe Oyna / B√ºy√ºƒüe Oyna‚Äù ve tutarƒ± otomatik verir.</div>
    </div>

    <!-- WARM-UP: Son 10 el -->
    <div id="warmPanel" class="warm">
      <div class="title">Ba≈ülangƒ±√ß Kalibrasyonu</div>
      <div class="p">Ba≈ülamak i√ßin <b>son 10 eli</b> gir. Tamamlanƒ±nca √∂neri a√ßƒ±lƒ±r. (<span id="wStat">0/10</span>)</div>
      <div class="row">
        <button id="wSmall" class="btn btn-win">Small</button>
        <button id="wBig" class="btn btn-loss">Big</button>
        <button id="wTie" class="btn btn-tie">Tie</button>
        <button id="wUndo" class="btn ghost">Geri Al</button>
        <button id="wClear" class="btn ghost">Temizle</button>
      </div>
      <div class="kbd" style="margin-top:8px">Kƒ±sayol: 1=Small ¬∑ 2=Big ¬∑ 3=Tie ¬∑ Backspace=Geri</div>
    </div>

    <div class="grid3" style="margin-top:10px">
      <button id="btnSmall" class="btn btn-win">SMALL geldi</button>
      <button id="btnBig"   class="btn btn-loss">BIG geldi</button>
      <button id="btnTie"   class="btn btn-tie">TIE geldi (Kayƒ±p)</button>
    </div>

    <div class="row">
      <button id="btnUndo" class="btn ghost">Geri Al</button>
      <button id="btnClear" class="btn ghost">T√ºm Kayƒ±tlarƒ± Sil</button>
      <div class="kbd">Kƒ±sayol: S = Small ¬∑ B = Big ¬∑ T = Tie ¬∑ Z = Geri</div>
    </div>

    <div class="kpi-grid">
      <div class="kpi"><div class="t">√ñneri (Bu El)</div><div class="v" id="kRecoText">Dur</div></div>
      <div class="kpi"><div class="t">Bank</div><div class="v" id="kBank">5000.00</div></div>
      <div class="kpi"><div class="t">Stake (Sƒ±radaki)</div><div class="v" id="kStake">30</div></div>
      <div class="kpi"><div class="t">Dinamik Taban (u)</div><div class="v" id="kUnit">30</div></div>
      <div class="kpi"><div class="t">HWM (Tepe)</div><div class="v" id="kHWM">5000.00</div></div>
      <div class="kpi"><div class="t">Bahisli Eller (W/L)</div><div class="v" id="kWL">0 / 0</div></div>
      <div class="kpi"><div class="t">PNL (Seans)</div><div class="v" id="kPNL">+0.00</div></div>
      <div class="kpi"><div class="t">Kayƒ±p Serisi (Bahis)</div><div class="v" id="kLStreak">0</div></div>
      <div class="kpi"><div class="t">W WinRate (20)</div><div class="v" id="kWR">‚Äî</div></div>
      <div class="kpi"><div class="t">G√∂lge PnL (What-if)</div><div class="v" id="kShadow">+0.00</div></div>
    </div>

    <div class="h4" style="margin-top:12px">Ge√ßmi≈ü</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th><th>Kaynak</th><th>√ñneri</th><th>Ger√ßek</th><th>Bahis</th><th>Sonu√ß</th><th>Net</th><th>Bank</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- AYARLAR (en altta) -->
  <div class="card settings">
    <div class="h4">Ayarlar</div>
    <div class="form">
      <div class="group">
        <label class="label" for="bankIn">Ba≈ülangƒ±√ß Bank</label>
        <input id="bankIn" class="input" type="number" value="5000" step="1" min="0"/>
      </div>
      <div class="group">
        <label class="label" for="unitIn">Ba≈ülangƒ±√ß Bahis (u)</label>
        <input id="unitIn" class="input" type="number" value="30" step="1" min="1"/>
      </div>
      <div class="group">
        <div class="small-actions">
          <button id="apply" class="btn">Uygula</button>
          <button id="reset" class="btn ghost">Varsayƒ±lana D√∂n</button>
        </div>
        <div class="note">Sadece ‚ÄúBank‚Äù ve ‚ÄúBa≈ülangƒ±√ß Bahis‚Äùi ayarlarsƒ±n; y√∂n se√ßimi ve risk y√∂netimi otomatik.</div>
      </div>
    </div>
  </div>
</div>

<!-- SR-Only canlƒ± b√∂lge -->
<div id="live" class="sr-only" aria-live="polite"></div>

<script>
(()=> {
/* ================== Sabitler ================== */
const MIN_WARMUP = 10;          // ba≈üta son 10 el gir
const W_WINRATE = 20;           // win-rate penceresi
const W_SIGNAL  = 12;           // sinyal penceresi
const Z_THR     = 1.10;         // Z-skor e≈üiƒüi (adaptif mean-revert)
const STREAK_TREND = 2;         // trend i√ßin min seri
const SERIES_LOCK  = 4;         // uzun seri i√ßin kilit a√ßma e≈üiƒüi
const HYST_OPP     = 2;         // kilidi bozmak i√ßin ardƒ±≈üƒ±k kar≈üƒ± sinyal
const HYST_LOSS    = 2;         // *** Kƒ∞Lƒ∞TTE 2 NET KAYIP ‚Üí Kƒ∞Lƒ∞Tƒ∞ √á√ñZ ***

const ENTRY_COOLDOWN = 1;       // flip-flop sonrasƒ± bekleme (1 el)

// Yumu≈üak stake artƒ±≈üƒ± (ani sƒ±√ßrama olmasƒ±n)
const MAX_STEP_U          = 2;     // tek el max +2u
const MAX_STEP_MULT       = 1.35;  // tek el max +%35
const MAX_STEP_MULT_LOCK  = 1.25;  // *** kilitte tek el max +%25 ***
const CYCLE_TP_U          = 3;     // HWM √ºzerinde mini TP (+3u)
const ADAPT_SERIES_LEN    = 6;     // seri uzadƒ±ƒüƒ±nda baskƒ±yƒ± azalt

/* ================== Durum ================== */
let baseBank = 5000, unit = 30;
let bank = baseBank, hwm = baseBank;
let stake = unit, maxStake = unit;
let lossStreak = 0;
let nHands = 0, wCount=0, lCount=0;

let recSide = 'NONE';           // 'S' | 'B' | 'NONE'
let recSource = 'NONE';         // 'TREND' | 'MEAN' | 'LOCK' | 'FALLBACK' | 'NONE'
let cooldown = 0;
let warmActive = true;
const warmSeq = [];
const histAll = [];             // ger√ßek sonu√ßlar: 'S'|'B'|'T'
const histSig = [];             // sinyal akƒ±≈üƒ±: 'S'|'B'  (TIE=n√∂tr)
const histBetWR = [];           // 1/0 yalnƒ±z bahisli eller

// Seri kilidi (histerezis)
let lockedSide = null;          // 'S' | 'B' | null
let oppSinceLockSig = 0;        // kilitliyken kar≈üƒ± sinyal sayacƒ±
let lockLossCount   = 0;        // kilitliyken net kayƒ±p sayacƒ±

// Bandit Beta (TREND vs MEAN)
const beta = { TREND:{a:1,b:1}, MEAN:{a:1,b:1} };
let shadowPNL = 0;              // what-if toplam

/* ================== Yardƒ±mcƒ±lar ================== */
const $ = id => document.getElementById(id);
function money(x){return (Number.isFinite(x)?x:0).toFixed(2);}
function setRecoBadge(side){
  const el = $('recoBadge'); const t = $('kRecoText');
  el.className = 'reco-badge ';
  if(side==='S'){ el.classList.add('reco-small'); el.textContent='K√º√ß√ºƒüe Oyna'; t.textContent='K√º√ß√ºƒüe Oyna'; }
  else if(side==='B'){ el.classList.add('reco-big'); el.textContent='B√ºy√ºƒüe Oyna'; t.textContent='B√ºy√ºƒüe Oyna'; }
  else{ el.classList.add('reco-wait'); el.textContent='Dur'; t.textContent='Dur'; }
}
function rollingWR(){ if(histBetWR.length===0) return null; return histBetWR.reduce((a,b)=>a+b,0) / histBetWR.length; }
function dynamicUnit(){
  const wr = rollingWR(); let f = 1.0;
  if(wr!==null){
    if(wr >= 0.58) f = 1.10;
    else if(wr >= 0.52) f = 1.04;
    else if(wr <= 0.46) f = 0.90;
    else if(wr <= 0.48) f = 0.96;
  }
  return Math.max(1, Math.round(unit*f));
}
function lastStreak(side){ let c=0; for(let i=histSig.length-1;i>=0;i--){ if(histSig[i]===side) c++; else break; } return c; }
function flipFlopDetected(){
  const a = histSig.slice(-4);
  return a.length===4 && (a[0]!==a[1] && a[0]===a[2] && a[1]===a[3]);
}
function zScoreForWindow(){
  const w = histSig.slice(-W_SIGNAL), n = w.length;
  if(n===0) return 0;
  const sCnt = w.filter(x=>x==='S').length;
  const mean = n*0.5, sd = Math.sqrt(n*0.25);
  if(sd===0) return 0;
  return (sCnt - mean)/sd; // + ise Small baskƒ±n; - ise Big baskƒ±n
}

/* ================== √ñneri √ßekirdeƒüi ================== */
function recommendCore(){
  // 1) SERƒ∞ Kƒ∞Lƒ∞Dƒ∞ (Histerezis)
  const sLen = lastStreak('S'), bLen = lastStreak('B');
  const lastSide = (sLen>0 && sLen>=bLen) ? 'S' : (bLen>0 ? 'B' : null);

  if(lockedSide===null){
    if(sLen >= SERIES_LOCK){ lockedSide='S'; oppSinceLockSig=0; lockLossCount=0; }
    else if(bLen >= SERIES_LOCK){ lockedSide='B'; oppSinceLockSig=0; lockLossCount=0; }
  }else{
    if(lastSide===lockedSide){ oppSinceLockSig=0; return {side:lockedSide, source:'LOCK'}; }
    else if(lastSide!==null){ // kar≈üƒ± y√∂nde akƒ±yor
      oppSinceLockSig++;
      if(oppSinceLockSig < HYST_OPP) return {side:lockedSide, source:'LOCK'};
      // e≈üik doldu ‚Üí kilit bƒ±rakƒ±lƒ±r (kayƒ±p bazlƒ± √ß√∂z√ºm ayrƒ±ca outcome i√ßinde)
      lockedSide = null; oppSinceLockSig=0; lockLossCount=0;
    }
  }
  if(lockedSide!==null) return {side:lockedSide, source:'LOCK'};

  // 2) Z-SKOR (adaptif mean-revert adayƒ±)
  const z = zScoreForWindow();
  let meanCand = null;
  if(z >= Z_THR) meanCand = {side:'B', source:'MEAN'}; // Small a≈üƒ±rƒ± ‚Üí Big'e d√∂n
  else if(z <= -Z_THR) meanCand = {side:'S', source:'MEAN'}; // Big a≈üƒ±rƒ± ‚Üí Small'a d√∂n

  // 3) TREND adayƒ±
  let trendCand = null;
  if(sLen >= STREAK_TREND) trendCand = {side:'S', source:'TREND'};
  else if(bLen >= STREAK_TREND) trendCand = {side:'B', source:'TREND'};

  // 3-bis) Mini bandit (TREND vs MEAN)
  if(trendCand && meanCand){
    const mTrend = beta.TREND.a/(beta.TREND.a+beta.TREND.b);
    const mMean  = beta.MEAN.a /(beta.MEAN.a +beta.MEAN.b);
    const jitterT = mTrend + (Math.random()*0.02-0.01);
    const jitterM = mMean  + (Math.random()*0.02-0.01);
    return (jitterT>=jitterM) ? trendCand : meanCand;
  }
  if(trendCand) return trendCand;
  if(meanCand)  return meanCand;

  // Belirsiz: sonsuz beklemeyi √∂nlemek i√ßin son akƒ±≈üa katƒ±l
  if(histSig.length>=2){
    return {side:(histSig[histSig.length-1]==='S'?'S':'B'), source:'FALLBACK'};
  }
  return {side:'NONE', source:'NONE'};
}

function computeNextRecommendation(){
  if(warmActive){ recSide='NONE'; recSource='NONE'; return; }

  if(flipFlopDetected()) cooldown = ENTRY_COOLDOWN;
  if(cooldown>0){ cooldown--; recSide='NONE'; recSource='NONE'; return; }

  const rec = recommendCore();
  recSide   = rec.side;
  recSource = rec.source;
}

/* ================== Stake ilerleme ================== */
function boundedSoft(prev, inc){
  const u = dynamicUnit();
  const capU = prev + MAX_STEP_U*u;
  const capP = Math.round(prev * (lockedSide ? MAX_STEP_MULT_LOCK : MAX_STEP_MULT));
  return Math.min(prev + inc, capU, capP);
}
function currentDD(){ return Math.max(0, hwm - bank); }
function dynamicK(dd, u){
  if(dd <= 5*u) return 2;
  if(dd <= 15*u) return 3;
  return 4;
}
function kellyAdj(){
  const p = rollingWR();
  if(p===null || p<=0.5) return 0;          // g√ºven yok ‚Üí ekleme yok
  return Math.min(0.25, 2*p - 1);           // 0 .. +0.25 arasƒ± yumu≈üak
}
function nextAfterLoss(prev){
  const u = dynamicUnit();
  const dd = currentDD();
  const K  = dynamicK(dd, u);
  const target = Math.max(u, Math.ceil(dd / Math.max(1,K))); // hedef: DD/K
  const incNeed = Math.max(0, target - prev);

  // kayƒ±p serisine g√∂re temel artƒ±≈ü (yumu≈üak)
  const baseK = [1.00,1.15,1.25,1.35][Math.min(3, lossStreak)];

  // son akƒ±≈ü y√∂n√º
  const last = histSig[histSig.length-1] || 'S';
  const seriesLen = lastStreak(last);

  // uzun seri ‚Üí baskƒ±yƒ± azalt
  const seriesMult = (seriesLen >= ADAPT_SERIES_LEN) ? 0.6 : 1.0;

  let inc = Math.max(Math.ceil(baseK*u*seriesMult), incNeed, u);
  let ns  = boundedSoft(prev, inc);

  // Kelly-lite olumluysa k√º√ß√ºk √ßarpan
  const kAdj = kellyAdj();
  ns = Math.round(ns * (1 + kAdj));

  // *** Kƒ∞Lƒ∞TTE ve akƒ±≈ü kilidin TERSƒ∞NE gidiyorsa ekstra yumu≈üatma ***
  if(lockedSide){
    const lockedAgainst = (lockedSide!==last);
    if(lockedAgainst){
      ns = Math.round(ns * 0.85);
      ns = Math.max(u, ns);
    }
  }

  return Math.max(u, ns);
}
function nextAfterWin(prev){
  const u = dynamicUnit();
  // HWM altƒ±nda ‚Üí stake d√º≈ü√ºrme; √ºst√ºnde ‚Üí daha hƒ±zlƒ± azalt
  if(bank < hwm) return Math.max(u, Math.round(prev));   // azaltma yok
  let ns = Math.max(u, prev - 2*u);                      // asimetrik hƒ±zlƒ± d√º≈ü√º≈ü
  return ns;
}

/* ================== UI g√ºncelleme ================== */
function refreshKPI(){
  $('kBank').textContent = money(bank);
  $('kStake').textContent = String(stake);
  $('kUnit').textContent  = String(dynamicUnit());
  $('kHWM').textContent   = money(hwm);
  $('kWL').textContent    = `${wCount} / ${lCount}`;
  $('kPNL').textContent   = (bank-baseBank>=0?'+':'-')+money(Math.abs(bank-baseBank));
  $('kLStreak').textContent = String(lossStreak);
  const wr = rollingWR(); $('kWR').textContent = wr===null?'‚Äî':(Math.round(wr*100)+'%');
  $('kShadow').textContent = (shadowPNL>=0?'+':'-')+money(Math.abs(shadowPNL));
  setRecoBadge(recSide);
  $('recoStake').textContent = String(stake);
}
function addRow(src, recUsed, actual, usedStake, outcomeStr, pnl, shadowThis){
  nHands++;
  const tr = document.createElement('tr');
  const recTxt = recUsed==='NONE'?'‚Äî':(recUsed==='S'?'Small':'Big');
  const actTxt = actual==='S'?'Small':(actual==='B'?'Big':'Tie');
  tr.innerHTML = `
    <td>${nHands}</td>
    <td>${src}</td>
    <td>${recTxt}</td>
    <td>${actTxt}</td>
    <td>${recUsed==='NONE'?'‚Äî':usedStake}</td>
    <td>${outcomeStr}
      ${recUsed!=='NONE'?`<div class="sub" style="opacity:.8">G√∂lge: ${(shadowThis>=0?'+':'-')+money(Math.abs(shadowThis))} ‚Ä¢ Toplam: ${(shadowPNL>=0?'+':'-')+money(Math.abs(shadowPNL))}</div>`:''}
    </td>
    <td>${recUsed==='NONE'?'‚Äî':(pnl>=0?'+':'-')+money(Math.abs(pnl))}</td>
    <td>${money(bank)}</td>
  `;
  const tb = $('tbody'); if(tb.firstChild) tb.insertBefore(tr, tb.firstChild); else tb.appendChild(tr);
  $('live').textContent = `El ${nHands}: ${actTxt} geldi, ${outcomeStr}.`;
}

/* ================== Warm-up ================== */
function warmUpdateUI(){ $('wStat').textContent = `${warmSeq.length}/${MIN_WARMUP}`; }
function warmAdd(tag){
  if(!warmActive) return;
  if(warmSeq.length>=MIN_WARMUP) return;
  warmSeq.push(tag); warmUpdateUI();
  if(warmSeq.length===MIN_WARMUP){
    for(const t of warmSeq){
      histAll.push(t);
      if(t==='T'){
        const last = histSig[histSig.length-1];
        if(last) histSig.push(last); // TIE = tarafsƒ±z (Big'e yazma)
      } else {
        histSig.push(t);
      }
    }
    warmSeq.length = 0;
    warmActive = false;
    $('warmPanel').style.display = 'none';
    computeNextRecommendation();
    refreshKPI();
  }
}
function warmUndo(){ if(warmActive && warmSeq.length>0){ warmSeq.pop(); warmUpdateUI(); } }
function warmClear(){ if(warmActive){ warmSeq.length=0; warmUpdateUI(); } }

/* ================== Sonu√ß i≈ülence ================== */
function onOutcome(tag){ // 'S' | 'B' | 'T'
  if(warmActive){ warmAdd(tag); return; }

  const recUsed = recSide;
  const srcUsed = recSource;
  const usedStake = (recUsed==='NONE') ? 0 : stake;

  // Kaydƒ± ekle (sinyal akƒ±≈üƒ±na TIE n√∂tr)
  histAll.push(tag);
  if(tag==='T'){
    const last = histSig[histSig.length-1];
    if(last) histSig.push(last); // n√∂tr: son y√∂n√º tekrar et
  }else{
    histSig.push(tag);
  }
  if(histSig.length>4000) histSig.shift();

  let pnl=0, out='Bekle', shadowThis=0;

  if(recUsed!=='NONE'){
    const isWin = (tag!=='T' && recUsed===tag); // TIE daima kayƒ±p
    if(isWin){
      pnl = +usedStake; bank += pnl; out='KAZAN'; wCount++; lossStreak=0;
      // bandit g√ºncelle
      if(srcUsed==='TREND') beta.TREND.a++; else if(srcUsed==='MEAN') beta.MEAN.a++;
      // stake
      stake = nextAfterWin(stake);
      histBetWR.push(1); if(histBetWR.length>W_WINRATE) histBetWR.shift();
      // kilit saya√ßlarƒ±
      if(lockedSide){ lockLossCount = 0; }
    }else{
      pnl = -usedStake; bank += pnl; out='KAYIP'; lCount++; lossStreak++;
      // bandit g√ºncelle
      if(srcUsed==='TREND') beta.TREND.b++; else if(srcUsed==='MEAN') beta.MEAN.b++;
      // *** kilitte kayƒ±p sayacƒ± ***
      if(lockedSide && recUsed===lockedSide){
        lockLossCount++;
        // z-skor kar≈üƒ±ya ta≈ümƒ±≈üsa veya 2 net kayƒ±p olduysa kilidi √ß√∂z
        const z = zScoreForWindow();
        const zOpp = (lockedSide==='S' && z<=-Z_THR) || (lockedSide==='B' && z>=Z_THR);
        if(zOpp || lockLossCount>=HYST_LOSS){
          lockedSide=null; oppSinceLockSig=0; lockLossCount=0;
        }
      }
      // stake
      stake = nextAfterLoss(stake);
      histBetWR.push(0); if(histBetWR.length>W_WINRATE) histBetWR.shift();
      // *** kilitte kayƒ±pta MEAN'e k√º√ß√ºk kredi (adaptasyon hƒ±zlansƒ±n) ***
      if(lockedSide) beta.MEAN.a += 0.25;
    }

    // What-if (kar≈üƒ± y√∂n) ‚Äî TIE her iki taraf i√ßin de kayƒ±p sayƒ±lƒ±r
    const altSide = (recUsed==='S') ? 'B' : 'S';
    const altWin  = (tag!=='T' && altSide===tag);
    shadowThis = altWin ? +usedStake : -usedStake;
    shadowPNL += shadowThis;
  }

  const prevHWM = hwm;
  if(bank>hwm) hwm = bank;
  if(hwm>prevHWM){ stake = dynamicUnit(); }                         // yeni tepe ‚Üí base
  if(bank>=hwm && (bank-baseBank) >= CYCLE_TP_U*dynamicUnit()){     // k√º√ß√ºk TP
    stake = dynamicUnit();
  }
  maxStake = Math.max(maxStake, stake);

  addRow(srcUsed, recUsed, tag, usedStake, out, pnl, shadowThis);

  computeNextRecommendation();
  refreshKPI();
}

/* ================== Undo / Clear / Apply ================== */
function replay(){
  bank = baseBank; hwm = baseBank; stake = unit; maxStake=unit;
  lossStreak=0; nHands=0; wCount=0; lCount=0;
  histAll.length=0; histSig.length=0; histBetWR.length=0;
  lockedSide=null; oppSinceLockSig=0; lockLossCount=0; cooldown=0;
  recSide='NONE'; recSource='NONE'; shadowPNL=0;
  beta.TREND={a:1,b:1}; beta.MEAN={a:1,b:1};
  $('tbody').innerHTML='';
  warmActive = true; warmSeq.length=0; $('warmPanel').style.display = 'block'; warmUpdateUI();
}
function undo(){
  if(warmActive){ warmUndo(); return; }
  if(!histAll.length) return;
  const copy = histAll.slice(0,-1);
  // reset ve tam yeniden y√ºr√ºtme
  bank = baseBank; hwm = baseBank; stake = unit; maxStake=unit;
  lossStreak=0; nHands=0; wCount=0; lCount=0;
  histAll.length=0; histSig.length=0; histBetWR.length=0;
  lockedSide=null; oppSinceLockSig=0; lockLossCount=0; cooldown=0;
  recSide='NONE'; recSource='NONE'; shadowPNL=0;
  beta.TREND={a:1,b:1}; beta.MEAN={a:1,b:1};
  $('tbody').innerHTML='';
  warmActive=false; $('warmPanel').style.display='none';

  for(const t of copy){ computeNextRecommendation(); onOutcome(t); }
  computeNextRecommendation();
  refreshKPI();
}
function clearAll(){ if(confirm('T√ºm kayƒ±tlarƒ± silmek istiyor musun?')){ replay(); refreshKPI(); } }
function apply(){
  const b = parseFloat($('bankIn').value);
  const u = parseFloat($('unitIn').value);
  if(!Number.isFinite(b)||b<0){alert('Ge√ßerli bank gir.');return}
  if(!Number.isFinite(u)||u<=0){alert('Ge√ßerli ba≈ülangƒ±√ß bahis gir.');return}
  baseBank=b; unit=Math.round(u);
  replay(); refreshKPI();
}

/* ================== Baƒülantƒ±lar ================== */
function guardTap(btn, pulseClass, cb){
  if(btn._lock) return; btn._lock=true;
  btn.classList.remove(pulseClass); void btn.offsetWidth; btn.classList.add(pulseClass);
  try{ cb(); } finally { setTimeout(()=>{ btn._lock=false; }, 220); }
}
$('btnSmall').addEventListener('click',()=>guardTap($('btnSmall'),'pulse-win', ()=>onOutcome('S')));
$('btnBig').addEventListener('click',  ()=>guardTap($('btnBig'),'pulse-loss', ()=>onOutcome('B')));
$('btnTie').addEventListener('click',  ()=>guardTap($('btnTie'),'pulse-tie',  ()=>onOutcome('T')));
$('btnUndo').addEventListener('click', ()=>undo());
$('btnClear').addEventListener('click',()=>clearAll());
$('apply').addEventListener('click',  ()=>apply());
$('reset').addEventListener('click',  ()=>{ $('bankIn').value=5000; $('unitIn').value=30; apply(); });

/* Warm-up butonlarƒ± */
$('wSmall').addEventListener('click', ()=>guardTap($('wSmall'),'pulse-win', ()=>warmAdd('S')));
$('wBig').addEventListener('click',   ()=>guardTap($('wBig'),'pulse-loss',()=>warmAdd('B')));
$('wTie').addEventListener('click',   ()=>guardTap($('wTie'),'pulse-tie', ()=>warmAdd('T')));
$('wUndo').addEventListener('click',  ()=>warmUndo());
$('wClear').addEventListener('click', ()=>warmClear());

/* Klavye: form alanlarƒ±nda deƒüilken */
document.addEventListener('keydown',(e)=>{
  const t = e.target.tagName.toLowerCase();
  if(t==='input'||t==='select'||t==='textarea') return;
  if(e.key==='s'||e.key==='S'){ e.preventDefault(); $('btnSmall').click(); }
  if(e.key==='b'||e.key==='B'){ e.preventDefault(); $('btnBig').click(); }
  if(e.key==='t'||e.key==='T'){ e.preventDefault(); $('btnTie').click(); }
  if(e.key==='z'||e.key==='Z'){ e.preventDefault(); $('btnUndo').click(); }
  if(e.key==='1'){ e.preventDefault(); $('wSmall').click(); }
  if(e.key==='2'){ e.preventDefault(); $('wBig').click(); }
  if(e.key==='3'){ e.preventDefault(); $('wTie').click(); }
  if(e.key==='Backspace'){ if(warmActive){ e.preventDefault(); $('wUndo').click(); } }
});

/* ================== Ba≈ülangƒ±√ß ================== */
$('warmPanel').style.display = 'block';
warmUpdateUI();
computeNextRecommendation();
refreshKPI();
})();
</script>
</body>
</html>
